library(tidyverse)
library(brms)
library(tidybayes)
library(modelr)
# data were retrieved from https://figshare.com/articles/dataset/Barton_et_al_2020_EcoLetters_Data_code_zip/11594595?file=20976921
GP_H_rate<-read.csv("Barton_et_al_2020_EcoLetters_Data_code/Metabolism schoolfield nlme/gross_photosynthesis_data_for_nlme.csv")
R_H_rate<-read.csv("Barton_et_al_2020_EcoLetters_Data_code/Metabolism schoolfield nlme/respiration_data_for_nlme.csv")

gp_r = full_join(GP_H_rate %>% rename(rateGP = rate.c.cell.c.h, lnGP = ln.rate),
                 R_H_rate %>% rename(rateR = rate.c.cell.c.h, lnR = ln.rate)) %>%
  arrange(ID)


# This model is a Bayesian equivalent of the model fitted by Barton et al. 2020
# Despite its being multivariate, the coefficients of the two formulas are estimated
# independently, i.e. ignoring potential species- or replicate-level correlations
# among coefficients
# (contrast with the model in photosynthesis_respiration_log_corr.R)

inits = list(
  b_lnGP_lnc = -3,
  b_lnGP_Ea = .7,
  b_lnGP_Eh = 5,
  b_lnGP_Th = 303,

  b_lnR_lnc = -4,
  b_lnR_Ea = .7,
  b_lnR_Eh = 5,
  b_lnR_Th = 305
)
list_of_inits = list(inits, inits, inits, inits)

m = brm(
  bf(
    lnGP | mi() ~ lnc + (Ea/(8.62 * 10^-5) * (1/293.15 - 1/K)) - log(1 + exp(Eh/(8.62 * 10^-5) * (1/Th - 1/(K)))),
    lnc ~ 1 + (1|species) + (1|rep)
    ,Ea ~ 1 + (1|species) + (1|rep)
    ,Eh ~ 1 + (1|species) + (1|rep)
    ,Th ~ 1 + (1|species) + (1|rep)
    ,sigma ~ 1 + (1|species)
    ,nl = T
  ) +
    bf(
      lnR | mi() ~ lnc + (Ea/(8.62 * 10^-5) * (1/293.15 - 1/K)) - log(1 + exp(Eh/(8.62 * 10^-5) * (1/Th - 1/(K)))),
      lnc ~ 1 + (1|species) + (1|rep)
      ,Ea ~ 1 + (1|species) + (1|rep)
      ,Eh ~ 1 + (1|species) + (1|rep)
      ,Th ~ 1 + (1|species) + (1|rep)
      ,sigma ~ 1 + (1|species)
      ,nl = T
    ) + set_rescor(FALSE),
  family = gaussian(),
  prior = prior(normal( -3,  1),resp = "lnGP",  nlpar = "lnc") +
    prior(normal( .7, .5),resp = "lnGP", nlpar = "Ea", lb = 0) +
    prior(normal(  5,  6),resp = "lnGP", nlpar = "Eh", lb = 0) +
    prior(normal(303,  10),resp = "lnGP", nlpar = "Th", lb = 273.15) +

    prior(normal(-4,   1),resp = "lnR",  nlpar = "lnc") +
    prior(normal( .7, .5),resp = "lnR", nlpar = "Ea", lb = 0) +
    prior(normal(  5,  6),resp = "lnR", nlpar = "Eh", lb = 0) +
    prior(normal(305,  10),resp = "lnR", nlpar = "Th", lb = 273.15),
  backend = "cmdstanr",
  init = list_of_inits,
  chains = 4,
  iter = 16000,
  warmup = 4000,
  thin = 1,
  control = list(adapt_delta = .99),
  cores = 4,
  seed = 321,
  data = gp_r
  ,file = "both_log_nocorr_reps_all"
)

summary(m)
# Multilevel Hyperparameters:
#   ~species (Number of levels: 18)
#                          Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# sd(sigma_lnGP_Intercept)     0.27      0.08     0.14     0.45 1.00    10119    15829
# sd(lnGP_lnc_Intercept)       1.03      0.20     0.73     1.49 1.00    15202    24380
# sd(lnGP_Ea_Intercept)        0.08      0.04     0.01     0.16 1.00     9550     8735
# sd(lnGP_Eh_Intercept)        2.19      0.54     1.28     3.41 1.00    17326    21687
# sd(lnGP_Th_Intercept)        3.72      0.66     2.68     5.25 1.00    16157    25643
# sd(sigma_lnR_Intercept)      0.30      0.07     0.18     0.46 1.00    18754    30323
# sd(lnR_lnc_Intercept)        1.05      0.21     0.74     1.53 1.00    15369    23992
# sd(lnR_Ea_Intercept)         0.17      0.05     0.09     0.27 1.00    17734    17898
# sd(lnR_Eh_Intercept)         0.65      0.19     0.33     1.08 1.00    18263    18852
# sd(lnR_Th_Intercept)         3.16      0.63     2.14     4.60 1.00    22402    31096
#
# ~rep (Number of levels: 55)
#                        Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# sd(lnGP_lnc_Intercept)     0.25      0.03     0.19     0.32 1.00    22314    29493
# sd(lnGP_Ea_Intercept)      0.09      0.03     0.04     0.14 1.00     8331    12654
# sd(lnGP_Eh_Intercept)      1.75      0.27     1.28     2.36 1.00    16243    25527
# sd(lnGP_Th_Intercept)      0.62      0.16     0.34     0.96 1.00    15297    20870
# sd(lnR_lnc_Intercept)      0.35      0.05     0.27     0.46 1.00    22253    30222
# sd(lnR_Ea_Intercept)       0.12      0.02     0.08     0.16 1.00    17283    25309
# sd(lnR_Eh_Intercept)       0.52      0.10     0.35     0.73 1.00    18825    25800
# sd(lnR_Th_Intercept)       0.36      0.26     0.02     0.98 1.00    14507    24757
#
# Regression Coefficients:
#                      Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# sigma_lnGP_Intercept    -1.62      0.08    -1.77    -1.46 1.00    17100    25130
# sigma_lnR_Intercept     -1.50      0.08    -1.66    -1.34 1.00    18092    27611
# lnGP_lnc_Intercept      -2.00      0.24    -2.49    -1.54 1.00     7149    13146
# lnGP_Ea_Intercept        0.73      0.03     0.68     0.79 1.00    30558    32480
# lnGP_Eh_Intercept        6.15      0.60     4.97     7.36 1.00    19831    27227
# lnGP_Th_Intercept      306.98      0.90   305.18   308.77 1.00     7249    14309
# lnR_lnc_Intercept       -3.32      0.25    -3.81    -2.83 1.00     8620    17602
# lnR_Ea_Intercept         1.04      0.05     0.94     1.13 1.00    22046    28715
# lnR_Eh_Intercept         2.79      0.20     2.42     3.19 1.00    24466    29106
# lnR_Th_Intercept       307.74      0.83   306.05   309.34 1.00    14783    23314




# These coefficients are fairly close to the ones reported in tables S3-4
# in the supplement
coef(m)$species
# , , sigma_lnGP_Intercept
#
#     Estimate Est.Error      Q2.5      Q97.5
# ac -1.481947 0.1333058 -1.729056 -1.2056676
# bn -1.541845 0.1272882 -1.778317 -1.2798799
# cr -1.310705 0.1637678 -1.608336 -0.9691062
# dt -1.542572 0.1466622 -1.815457 -1.2378865
# eh -1.255556 0.1983499 -1.607470 -0.8353358
# go -1.549769 0.1666174 -1.855691 -1.2013434
# gs -1.849681 0.1610865 -2.160127 -1.5319429
# mp -1.686271 0.1375325 -1.950687 -1.4090456
# ns -1.586850 0.1287052 -1.827289 -1.3216264
# ot -1.632026 0.1570809 -1.926221 -1.3122623
# pa -1.689005 0.1216523 -1.917937 -1.4422626
# pp -1.717157 0.1484849 -1.996773 -1.4144401
# pt -2.023552 0.1754812 -2.356675 -1.6732001
# rm -1.962004 0.1489907 -2.245685 -1.6625103
# sc -1.872987 0.1495470 -2.158338 -1.5734286
# st -1.336951 0.1252608 -1.565990 -1.0774814
# th -1.628008 0.1334940 -1.877983 -1.3530091
# tp -1.539134 0.1255236 -1.771511 -1.2794499
#
# , , lnGP_lnc_Intercept
#
#      Estimate Est.Error       Q2.5      Q97.5
# ac -2.9847496 0.1493293 -3.2796083 -2.6911885
# bn -2.2211782 0.1500571 -2.5173234 -1.9271210
# cr -1.4266005 0.1637448 -1.7495732 -1.1065388
# dt -1.0393357 0.1529915 -1.3418482 -0.7370350
# eh -2.6881008 0.1593348 -3.0032366 -2.3724269
# go -0.6918650 0.1512335 -0.9922391 -0.3966790
# gs -2.2846353 0.1484304 -2.5745900 -1.9906768
# mp -2.6446186 0.1358350 -2.9134905 -2.3789785
# ns -1.9788360 0.1471478 -2.2676139 -1.6885439
# ot -1.4267130 0.1493965 -1.7211548 -1.1339497
# pa -1.1176268 0.1480680 -1.4120828 -0.8277931
# pp -2.7106038 0.1473527 -2.9989015 -2.4166977
# pt -1.6838056 0.1449509 -1.9692325 -1.3978999
# rm -2.1568367 0.1465235 -2.4451276 -1.8688274
# sc  0.4976758 0.1482271  0.1971782  0.7848507
# st -2.6700911 0.1518859 -2.9705802 -2.3707700
# th -3.4077797 0.1524586 -3.7046948 -3.1045397
# tp -2.2656535 0.1476722 -2.5570636 -1.9744699
#
# , , lnGP_Ea_Intercept
#
#     Estimate  Est.Error      Q2.5     Q97.5
# ac 0.7787855 0.06371212 0.6645215 0.9135494
# bn 0.7553930 0.05520149 0.6510681 0.8693909
# cr 0.7682428 0.07519747 0.6312300 0.9332594
# dt 0.6357118 0.06571204 0.5047960 0.7534530
# eh 0.8263833 0.08246682 0.6874648 0.9999893
# go 0.8240359 0.07692591 0.6936402 0.9827133
# gs 0.7176740 0.05247838 0.6117001 0.8209801
# mp 0.7168126 0.05517434 0.6054839 0.8274342
# ns 0.7900746 0.05805120 0.6846421 0.9080921
# ot 0.6089024 0.07857407 0.4520888 0.7471492
# pa 0.6834614 0.05170599 0.5795093 0.7821734
# pp 0.7024869 0.04974465 0.6003898 0.7991439
# pt 0.7415676 0.04724950 0.6485578 0.8369536
# rm 0.7186741 0.05019810 0.6176249 0.8183296
# sc 0.7128784 0.04868548 0.6147310 0.8085561
# st 0.7122905 0.05351584 0.6033311 0.8166731
# th 0.7217607 0.05702676 0.6059587 0.8352002
# tp 0.7586026 0.05234210 0.6596539 0.8673891
#
# , , lnGP_Eh_Intercept
#
#    Estimate Est.Error     Q2.5     Q97.5
# ac 5.122505 0.9678588 3.230066  7.020420
# bn 5.235434 1.0093071 3.274156  7.243394
# cr 3.926102 1.0139791 1.957073  5.974809
# dt 8.313963 1.2036175 6.003719 10.744117
# eh 8.991432 1.5245980 6.112009 12.129397
# go 9.547709 1.3272461 6.995144 12.200408
# gs 6.362523 0.9666791 4.471320  8.271335
# mp 4.341458 0.9054113 2.605251  6.160873
# ns 6.338560 0.9982943 4.376210  8.302259
# ot 5.335607 1.1476022 3.128748  7.637425
# pa 4.399565 0.9808214 2.486565  6.361025
# pp 7.992371 1.0190201 6.011395 10.010539
# pt 8.739302 1.0885554 6.614192 10.913335
# rm 4.505794 0.9734547 2.612068  6.429620
# sc 6.047207 1.0265863 4.075329  8.109316
# st 4.876867 1.0215487 2.887055  6.915264
# th 4.172406 0.9744538 2.295703  6.136064
# tp 6.684027 1.0488064 4.637499  8.780862
#
# , , lnGP_Th_Intercept
#
#    Estimate Est.Error     Q2.5    Q97.5
# ac 304.4730 0.6230729 303.2485 305.6981
# bn 306.7928 0.6260596 305.5333 307.9950
# cr 303.7125 0.9789136 301.8368 305.6949
# dt 312.7753 0.5199464 311.7065 313.7627
# eh 302.8199 0.5033304 301.8171 303.8168
# go 303.6368 0.4414364 302.7799 304.5252
# gs 309.5337 0.4762533 308.5635 310.4513
# mp 301.3736 0.6341014 300.0869 302.6011
# ns 308.0837 0.5546854 306.9633 309.1525
# ot 308.8108 0.7283421 307.2642 310.1203
# pa 312.9027 0.7000517 311.4734 314.2249
# pp 311.8863 0.4644450 310.9332 312.7711
# pt 307.2768 0.4244821 306.4247 308.1222
# rm 306.5591 0.5963975 305.3673 307.7126
# sc 305.6684 0.5006832 304.6693 306.6527
# st 310.9832 0.8218258 309.3088 312.5324
# th 302.5308 0.7252466 301.0750 303.9305
# tp 306.1165 0.5271862 305.0522 307.1235
#
# , , sigma_lnR_Intercept
#
#      Estimate Est.Error      Q2.5     Q97.5
# ac -1.9337534 0.1566640 -2.226395 -1.616303
# bn -1.5401833 0.1349755 -1.791880 -1.261943
# cr -1.6836060 0.1818068 -2.033094 -1.322858
# dt -1.4577959 0.1472878 -1.736078 -1.159946
# eh -0.8339255 0.1400110 -1.090620 -0.543448
# go -1.4276322 0.1522400 -1.711569 -1.114009
# gs -1.4574705 0.1367267 -1.713083 -1.176112
# mp -1.3806247 0.1390080 -1.639282 -1.092493
# ns -1.5103463 0.1457887 -1.781542 -1.210213
# ot -1.3956072 0.1362437 -1.648442 -1.116165
# pa -1.6855002 0.1314906 -1.932048 -1.416368
# pp -1.5499010 0.1354448 -1.805350 -1.272295
# pt -1.3347857 0.1145783 -1.548512 -1.101116
# rm -1.5869113 0.1242583 -1.820235 -1.334168
# sc -1.9015031 0.1426844 -2.170067 -1.611246
# st -1.3428503 0.1126101 -1.552906 -1.110119
# th -1.6099334 0.1407138 -1.873576 -1.318827
# tp -1.4369688 0.1345463 -1.687496 -1.158351
#
# , , lnR_lnc_Intercept
#
#     Estimate Est.Error      Q2.5     Q97.5
# ac -3.350440 0.2024282 -3.750258 -2.953149
# bn -3.649561 0.2125500 -4.064262 -3.233462
# cr -2.030153 0.2082963 -2.443369 -1.621519
# dt -2.912855 0.2131642 -3.334976 -2.496080
# eh -3.838595 0.2285814 -4.284222 -3.388153
# go -2.229942 0.2180903 -2.659835 -1.801158
# gs -3.542921 0.2132494 -3.957837 -3.122677
# mp -4.261516 0.1942272 -4.642762 -3.877068
# ns -3.607228 0.2083936 -4.013305 -3.194302
# ot -2.707310 0.2105658 -3.126212 -2.294937
# pa -2.087874 0.2078517 -2.501356 -1.682426
# pp -4.756567 0.2077402 -5.161741 -4.339040
# pt -2.881527 0.2116022 -3.299003 -2.462955
# rm -3.811155 0.2072184 -4.215776 -3.403124
# sc -1.058898 0.2090075 -1.478565 -0.653440
# st -4.034873 0.2115371 -4.444811 -3.612675
# th -4.362139 0.2165196 -4.781101 -3.929015
# tp -3.789587 0.2083247 -4.194307 -3.379880
#
# , , lnR_Ea_Intercept
#
#     Estimate  Est.Error      Q2.5    Q97.5
# ac 0.8674767 0.07509939 0.7250939 1.019201
# bn 1.1870437 0.09223261 1.0101950 1.372563
# cr 0.9795746 0.08196397 0.8196833 1.142769
# dt 0.9360348 0.08785021 0.7662460 1.111796
# eh 1.1177371 0.12670730 0.8768052 1.374221
# go 1.1551604 0.11961185 0.9321365 1.401911
# gs 1.0041692 0.08933743 0.8307426 1.183894
# mp 1.1234672 0.08628120 0.9574539 1.297749
# ns 1.2772958 0.09786026 1.0819285 1.468175
# ot 1.2279347 0.11985376 1.0097940 1.479694
# pa 0.8855718 0.07806583 0.7357129 1.041649
# pp 1.1741326 0.08871545 1.0047488 1.351429
# pt 0.9559479 0.09020383 0.7778228 1.133974
# rm 0.8915343 0.08188836 0.7313184 1.052545
# sc 1.0508248 0.07271033 0.9078538 1.195138
# st 0.8987601 0.08410305 0.7342987 1.064425
# th 1.0182838 0.08905034 0.8461447 1.197268
# tp 0.9528629 0.08102777 0.7945126 1.113210
#
# , , lnR_Eh_Intercept
#
#    Estimate Est.Error     Q2.5    Q97.5
# ac 3.083971 0.4120997 2.306272 3.933055
# bn 2.156832 0.3051291 1.570416 2.767324
# cr 2.892959 0.4127651 2.117166 3.737968
# dt 3.366706 0.6031174 2.338325 4.696703
# eh 3.220962 0.4484851 2.396892 4.157174
# go 2.417836 0.3598507 1.733649 3.143424
# gs 3.631367 0.3787899 2.889700 4.379226
# mp 2.364161 0.2940416 1.803308 2.961200
# ns 3.420291 0.3844472 2.687202 4.192754
# ot 2.513574 0.3987448 1.763266 3.327133
# pa 2.324256 0.3114106 1.719420 2.943565
# pp 3.437698 0.4101089 2.669525 4.278544
# pt 2.722432 0.2918499 2.155370 3.306228
# rm 2.733485 0.4127866 1.958491 3.585114
# sc 2.301397 0.3087753 1.703775 2.913808
# st 2.221065 0.3128519 1.614879 2.845865
# th 2.233480 0.3486038 1.571449 2.949646
# tp 3.134927 0.3785214 2.424820 3.909706
#
# , , lnR_Th_Intercept
#
#    Estimate Est.Error     Q2.5    Q97.5
# ac 314.1409 0.8603782 312.1963 315.5839
# bn 305.3119 1.3816429 302.6106 308.0348
# cr 308.3867 1.0440218 306.0940 310.2463
# dt 312.0736 1.0524336 309.6927 313.8011
# eh 305.0539 1.1797906 302.5831 307.2663
# go 305.1738 1.6335935 301.9342 308.3277
# gs 310.3675 0.7567967 308.7892 311.7629
# mp 302.8682 1.1908489 300.4866 305.2099
# ns 307.0630 0.7818902 305.4849 308.5765
# ot 307.2758 1.7669094 303.6568 310.5592
# pa 310.9736 1.1668654 308.5618 313.1538
# pp 309.6293 0.8363824 307.8606 311.1398
# pt 307.7948 0.9314059 305.9294 309.6110
# rm 308.3549 1.0859310 305.9962 310.2694
# sc 307.7023 0.9190438 305.8472 309.4688
# st 306.3331 1.3090953 303.6630 308.8105
# th 304.7999 1.7030771 301.3437 308.0122
# tp 306.2743 0.8599236 304.4653 307.8407

